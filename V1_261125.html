<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Operant Lab – V2</title>

  <!-- jsPsych & plugins -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>  
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />

  <style>
    body { margin:0; padding:0; background:#f0f0f0; font-family:Arial, sans-serif; }
    #ui-container { display:flex; flex-direction:column; width:100vw; height:100vh; }
    #keys-area { flex:2; position:relative; overflow:hidden; }
    #reinforcement-area { flex:1; position:relative; overflow:hidden; }
    .circle { width:20px; height:20px; border-radius:50%; position:absolute; }
    .center-dot { width:14px; height:14px; border-radius:50%; position:absolute; z-index:2; }
    .label { position:absolute; text-align:center; font-size:14px; color:#444; }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <!-- Core (V2, global/IIFE versions) -->
  <script src="trial_context.js"></script>
  <script src="schedules_router.js"></script>
  <script src="schedule_vr.js"></script>
  <script src="schedule_vi.js"></script>
  <script src="schedule_vt.js"></script>
  <script src="schedule_extinction.js"></script>
  <script src="schedule_session_end.js"></script>

  <!-- Managers / UI -->
  <script src="ResponseKeyManager.js"></script>
  <script src="OperantDiskManager.js"></script>
  <script src="StatusDisplay.js"></script>
  <script src="ReinforcementManager.js"></script>
  <script src="UIManager.js"></script>

  <!-- Params -->
  <script src="trial_list.js"></script>

  <!-- TEXTES ET QUESTIONS -->
  <script src="module_create_instruction.js"></script>
  <script src="module_instruction_number.js"></script>  
  <script src="module-age-participant.js"></script>  
  <script src="module-gender-participant.js"></script>    
  <script src="CreateInstructionNumberAndDisplayInstruct.js"></script>    

  

  <!-- Session -->
  <script src="SessionManager.js"></script>

  <!-- Trial -->
  <script src="trial.js"></script>

  <!-- Start + export CSV -->
  <script>
    function downloadCSVWithColumns(filename, rows, columns) {
      const header = columns.join(',');
      const escape = (v) => {
        if (v === null || v === undefined) return '';
        const s = String(v);
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
      };
      const body = rows.map(r => columns.map(c => escape(r[c])).join(',')).join('\n');
      const csv = header + '\n' + body;
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    let dataAlreadySaved = false;

    function exportDataAsCSV() {
      if (dataAlreadySaved) return;
      dataAlreadySaved = true;

      const jsPsych = window.JSP;
      const data = jsPsych.data.get();

      const ageTrial = data.filter({ task: 'Age' }).values()[0];
      const genderTrial = data.filter({ task: 'Gender' }).values()[0];
      const codeTrial = data.filter({ task: 'enter_participant_code' }).values()[0];

      const age = Object.values(ageTrial?.response ?? {})[0] ?? '';
      const gender = Object.values(genderTrial?.response ?? {})[0] ?? '';
      const participant_code = codeTrial?.response?.participant_code?.trim() ?? '';

      const participantRow = { age, gender, participant_code };
      const trialData = data.values();
      const allData = [participantRow, ...trialData];

      const columns = [
        'age', 'gender', 'participant_code',
        'timestamp', 'trial_number', 'event_type', 'started_at',
        'elapsed_since_trial_start', 'block_index',
        'elapsed_since_block_start',
        'schedule_type', 'schedule_min', 'schedule_max', 'schedule_criterion', 'key_id',
        'reinforcement_available', 'points',
        'response_index', 'active_key', 'target_location', 'click_x', 'click_y',
        'trial_index', 'trial_type', 'internal_node_id'
      ];

      // const ts = new Date().toISOString().replace(/[:.]/g, '').slice(0, 15);
      // const filename = 'session_data_' + ts + '.csv';
      // Timestamp compact
      const ts = new Date().toISOString().replace(/[:.]/g, '').slice(0, 15);
      // Récupère le nom du fichier HTML actuellement chargé
      const htmlFile = window.location.pathname.split('/').pop().replace('.html', '');
      // Construit un nom de fichier plus informatif
      const filename = `session_data_${ts}_HTML${htmlFile}.csv`;

      downloadCSVWithColumns(filename, allData, columns);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const jsPsych = initJsPsych({
        override_safe_mode: true,
        on_finish: () => {
          exportDataAsCSV();
        }
      });

      window.JSP = jsPsych;

      const instruction_number_trial = createInstructionNumber();

const generate_instruction_trial = {
  type: jsPsychCallFunction,
  //async: true,
  func: function (done) {
    const lastTrial = jsPsych.data.getLastTrialData().values()[0];
    const code = lastTrial?.response?.participant_code ?? '';
    let instruction_number = parseInt(code.slice(-1), 10);

    if (![1, 2].includes(instruction_number)) {
      instruction_number = 3;
    }

    const instruction_trial = createInstructionTrial(instruction_number);

    jsPsych.addNodeToEndOfTimeline(
      { timeline: [instruction_trial] },
      done
    );
  }
};
      const instruction_block = CreateInstructionNumberAndDisplayInstructions(jsPsych);
      const age_trial = createAgeTrial();
      const gender_trial = createGenderTrial();

      const timeline = [
          instruction_block,
        age_trial,
        gender_trial,
        trial, // Défini dans trial.js
       {
         type: jsPsychCallFunction,
         func: () => {
           jsPsych.endExperiment();
         }
       }
      ];

      jsPsych.run(timeline);
    });

    window.addEventListener('beforeunload', () => {
      exportDataAsCSV();
    });
  </script>
</body>
</html>
